<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; overflow: hidden; color: #0036FF; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        #map { position:absolute; top:0; bottom:-300px; width:100%; }
        #animationControl { position:absolute; top:0px; left:0px; padding: 4px; width: 40px; height: 40px; line-height: 40px; z-index: 20000; cursor: pointer; }
        .play { background: url('img/play.svg') center center no-repeat; }
        .stop { background: url('img/stop.svg') center center no-repeat; }

        #maneuverIndicate { text-align: center; position:absolute; bottom:30px; left:30px; padding: 0px; z-index: 20000; }
        #maneuverIndicateArrow { width: 70px; height: 70px; text-align: center; }
        #maneuverIndicateDistance { font-size: 32px; margin-top: 12px; }
        #maneuverIndicateDistanceMeasure { font-size: 16px; margin-top: 6px; }
        .left { background: url('img/left.svg') center center no-repeat; }
        .right { background: url('img/right.svg') center center no-repeat; }
        .slight-left { background: url('img/slight-left.svg') center center no-repeat; }
        .slight-right { background: url('img/slight-right.svg') center center no-repeat; }
        .straight { background: url('img/straight.svg') center center no-repeat; }
        #bottomGradient { opacity: 0.8; position:absolute; bottom:0; left:0; right: 0; height: 150px; z-index: 1500; background-image: linear-gradient(-180deg, rgba(255,255,255,0.00) 0%, #FFFFFF 84%); }
        #maneuverIndicateName { font-size: 20px; position:absolute; top:0; left:0; right: 0; line-height: 60px; z-index: 1500; text-align: center; }

        #speedIndicate { text-align: center; position:absolute; bottom:30px; right:30px; padding: 0px; z-index: 20000; }
        #speedIndicateSpeedMeasure { font-size: 16px; margin-top: 6px; }
        #speedIndicateSpeed { font-size: 32px; margin-top: 12px;  }

    </style>
</head>
<body>
<div id='animationControl'></div>
<div id='bottomGradient'></div>
<div id='maneuverIndicateName'></div>
<div id='maneuverIndicate'>
  <div id='maneuverIndicateArrow'> </div>
  <div id='maneuverIndicateDistance'></div>
  <div id='maneuverIndicateDistanceMeasure'></div>
</div>
<div id='speedIndicate'>
  <div id='speedIndicateSpeed'>58</div>
  <div id='speedIndicateMeasure'>km/h</div>
</div>
<div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmF2aWdhdGlvbm1hcCIsImEiOiJjajdpeXV5bmsxd3o1MndvMmI3YW9uN2MzIn0.j1jNy4T7WkerOCWEfL7iIA';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/navigationmap/cj7iz82eb5u482rnkh5cyud3m', //hosted style id
    center: [-122.41, 37.78], // starting position
    zoom: 13 // starting zoom
});

var state = {
  animation: false,
  passedPoint: false,
  distance: 0,
  speed: 50, //in ms interval
  increment: 0.002,
  point: [-122.41, 37.78],
  pitch: 60,
  bearing: 0,
  length: 0,
  zoom: 16
}

var routeLine, nextPoint, maneuverPoints;
var interval;

var animationControl = d3.select("#animationControl"),
    maneuverIndicateName = d3.select("#maneuverIndicateName"),
    maneuverIndicateArrow = d3.select("#maneuverIndicateArrow"),
    maneuverIndicateDistance = d3.select("#maneuverIndicateDistance"),
    maneuverIndicateDistanceMeasure = d3.select("#maneuverIndicateDistanceMeasure");


var routeStyleSimple = {
  "id": "route",
  "type": "line",
  "filter": ["==", "type", "route"],
  "source": "route",
  "paint": {
    "line-color": "#000fff",
    "line-width": 5
  }
};

var routeStyleTraffic = {
  "id": "routeTraffic",
  "after": "road-label-small",
  "type": "line",
  "filter": ["==", "type", "traffic"],
  "source": "route",
  "layout": {
    "line-cap": "round"
  },
  "paint": {
    "line-color": {
      "property": "speed",
      "type": "exponential",
      "stops": [
        [10, "#991515"],
        [20, "#E82D2D"],
        [40, "#EBC534"],
        [90, "#2FAF1E"]
      ]
    },
    "line-width": 10
  }
};

var pointerStyleBg = {
  "id": "pointerBg",
  "type": "circle",
  "source": "point",
  "paint": {
    "circle-color": "#fff",
    "circle-opacity": 0.58,
    "circle-radius": 20
  }
};

var pointerStyle = {
  "id": "pointer",
  "type": "circle",
  "source": "point",
  "paint": {
    "circle-color": "#06f",
    "circle-opacity": 1,
    "circle-radius": 8
  }
};

var maneuverStyle = {
  "id": "maneuver",
  "type": "circle",
  "source": "route",
  "filter": ["==", "type", "maneuver"],
  "paint": {
    "circle-color": "#06f",
    "circle-opacity": 1,
    "circle-radius": 4
  }
};

toggleAnimation = () => {
  if(!state.animation) {
    interval = setInterval(moveNext, state.speed);
    state.animation = true;
    animationControl.attr("class", "stop");
  } else {
    clearInterval(interval);
    state.animation = false;
    animationControl.attr("class", "play");
  }
}

moveNext = () => {

  state.distance += state.increment;
  if((state.distance-state.increment) > state.length) {
    state.distance = 0;
    resetManeuverPoints();
  }
  state.point = turf.along(routeLine, state.distance, 'kilometers');

  state.bearing = turf.bearing(state.point, turf.along(routeLine, (state.distance+state.increment), 'kilometers'));

  //      map.setPitch
  map.easeTo({
      center: state.point.geometry.coordinates,
      bearing: state.bearing,
      pitch: state.pitch,
      zoom: state.zoom
  });

  var nearest = turf.nearest(state.point, {type: "FeatureCollection", features: maneuverPoints.features.filter(f=>!f.properties.passed)});
  var maneuverDistance = turf.distance(state.point, nearest, "kilometers");

  maneuverIndicateDistance.text(formatter(maneuverDistance));
  maneuverIndicateDistanceMeasure.text(formatterM(maneuverDistance));
  maneuverIndicateName.text(nearest.properties.name);
  maneuverIndicateArrow.attr("class", nearest.properties.arrow);

  if(maneuverDistance < state.increment*2) {
    maneuverPoints.features.forEach(f=>{
      if(f.properties.id === nearest.properties.id) {
        f.properties.passed = true;
      }
    });
  }


  map.getSource("point").setData({type: "FeatureCollection", features: [state.point]});

}

resetManeuverPoints = () => {
  maneuverPoints.features.forEach((f,i)=>{
    f.properties['passed'] = false;
    f.properties['id'] = i;
  });
}

formatter = (v) => {
  var r;
  if(v>0) r = Math.floor(v*1000);
  if(v>0.1) r = Math.floor(v*100)*10;
  if(v>1) r = Math.floor(v*10)/10;
  if(v>10) r = Math.floor(v);

  return r;
}

formatterM = (v) => {
  var r;
  if(v>0) r ="m";
  if(v>1) r = "km";
  if(v>10) r = "km";
  return r;
}

map.on('click', function(e) {
     // set bbox as 5px reactangle area around clicked point
     var bbox = [[e.point.x - 5, e.point.y - 5], [e.point.x + 5, e.point.y + 5]];
     var features = map.queryRenderedFeatures(bbox, { layers: ['maneuver'] });
     console.log(features);
  });

map.on('load', ()=> {

  d3.json('./data/route.geojson?' + Math.random(), json => {

//             const routeSrc = json.routes[0];
    routeLine = json.features[0];
    maneuverPoints = { type: "FeatureCollection", features: json.features.filter((f)=> f.properties.type === "maneuver") }

    resetManeuverPoints(); //reset maneuver points flag

    state.length = turf.lineDistance(routeLine, 'kilometers');
    state.point = turf.along(routeLine, state.distance, 'kilometers');

    map.addSource("route", { type: "geojson", data: json });
    map.addLayer(routeStyleTraffic);

    map.addSource("point", { type: "geojson", data: {type: "FeatureCollection", features: [state.point]} });
    map.addLayer(pointerStyleBg);
    map.addLayer(pointerStyle);
    map.addLayer(maneuverStyle);

    animationControl.attr("class", "play");
    animationControl.on('click', toggleAnimation); //bind



 });




})

//request for example
//https://api.mapbox.com/directions/v5/mapbox/driving-traffic/-122.381405%2C37.738277%3B-122.45771097983936%2C37.78540378184813.json?geometries=polyline&alternatives=true&steps=true&overview=full&access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4M29iazA2Z2gycXA4N2pmbDZmangifQ.-g_vE53SD2WrJ6tFX7QHmA

</script>


</body>
</html>
